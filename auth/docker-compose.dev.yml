# # RUN line below for dev & test # #
# docker-compose -p mynute-go-auth -f auth/docker-compose.dev.yml up -d --force-recreate

services:
  postgres:
    image: postgres:17.5
    restart: always
    volumes:
      - ./postgres-data:/var/lib/postgresql/data
    env_file:
      - .env
    ports:
      - "${POSTGRES_PORT}:${POSTGRES_PORT}"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB_DEV}"]
      interval: 300s
      timeout: 5s
      retries: 10
      start_period: 5s
    command: >
      bash -c "
        echo '‚úÖ   Starting PostgreSQL...';
        docker-entrypoint.sh postgres & 

        # Wait for PostgreSQL to be fully ready
        echo '‚è≥   Waiting for PostgreSQL to start...';
        until pg_isready -h localhost -p 5432 -U $POSTGRES_USER; do
          echo '‚è≥   Still waiting for PostgreSQL...';
          sleep 5;
        done;

        echo '‚úÖ   PostgreSQL is ready! Proceeding with initialization...';

        # Ensure the main database exists
        echo \"Checking if main database '$POSTGRES_DB' exists...\";
        if psql -U \"$POSTGRES_USER\" -d postgres -tAc \"SELECT 1 FROM pg_database WHERE datname='$POSTGRES_DB'\" | grep -q 1; then
          echo '‚úÖ   Main database \"$POSTGRES_DB\" already exists.';
        else
          echo 'üöÄ   Creating main database: \"$POSTGRES_DB\"';
          psql -U \"$POSTGRES_USER\" -d postgres -c \"CREATE DATABASE \\\"$POSTGRES_DB\\\";\";
        fi;

        # Check if test database exists and create schema 'public'
        echo \"Checking if test database '$POSTGRES_DB_TEST' exists...\";
        if psql -U \"$POSTGRES_USER\" -d postgres -tAc \"SELECT 1 FROM pg_database WHERE datname='$POSTGRES_DB_TEST'\" | grep -q 1; then
          echo '‚úÖ   Test database \"$POSTGRES_DB_TEST\" already exists.';
        else
          echo 'üöÄ   Creating test database: \"$POSTGRES_DB_TEST\"';
          psql -U \"$POSTGRES_USER\" -d postgres -c \"CREATE DATABASE \\\"$POSTGRES_DB_TEST\\\";\";
        fi;

        echo \"Checking if dev database '$POSTGRES_DB_DEV' exists...\";
        if psql -U \"$POSTGRES_USER\" -d postgres -tAc \"SELECT 1 FROM pg_database WHERE datname='$POSTGRES_DB_DEV'\" | grep -q 1; then
          echo '‚úÖ   Dev database \"$POSTGRES_DB_DEV\" already exists.';
        else
          echo 'üöÄ   Creating dev database: \"$POSTGRES_DB_DEV\"';
          psql -U \"$POSTGRES_USER\" -d postgres -c \"CREATE DATABASE \\\"$POSTGRES_DB_DEV\\\";\";
        fi;

        echo 'üîß   Ensuring schema public exists on main database...'
        psql -U \"$POSTGRES_USER\" -d \"$POSTGRES_DB\" -c 'CREATE SCHEMA IF NOT EXISTS public;';
        
        echo 'üîß   Ensuring schema public exists on test database...';
        psql -U \"$POSTGRES_USER\" -d \"$POSTGRES_DB_TEST\" -c 'CREATE SCHEMA IF NOT EXISTS public;';

        echo 'üîß   Ensuring schema public exists on dev database...'
        psql -U \"$POSTGRES_USER\" -d \"$POSTGRES_DB_DEV\" -c 'CREATE SCHEMA IF NOT EXISTS public;';

        echo 'üéâ   Database initialization complete!';

        # Keep PostgreSQL running in the foreground to prevent container exit
        wait
      "
    networks:
      - mynute-auth-network

  mailhog:
    image: mailhog/mailhog
    restart: always
    ports:
      - "1025:1025"  # SMTP
      - "8025:8025"  # Web UI
    networks:
      - mynute-auth-network
   
networks:
  mynute-auth-network:

volumes:
  postgres-data:
