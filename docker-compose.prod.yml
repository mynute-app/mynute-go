version: '3.8'
# # RUN line below for prod in local machine # #
# # # docker compose -p mynuteapp-backend-main-go-qibr49 -f ./docker-compose.prod.yml up -d --build --remove-orphans

# # ADD line below for prod in VPS using Dokploy at Advanced > Run Command # #
# compose build --no-cache && docker compose up -d --force-recreate

services:
  postgres:
    image: postgres:17.5
    restart: always
    volumes:
      - ./postgres-data:/var/lib/postgresql/data
    env_file:
      - .env
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB_PROD:-maindb}"]
      interval: 300s
      timeout: 5s
      retries: 10
      start_period: 15s
    command: >
      bash -c "
        echo '‚úÖ   Starting PostgreSQL...';
        docker-entrypoint.sh postgres &

        # Wait for PostgreSQL to be fully ready
        echo '‚è≥   Waiting for PostgreSQL to start...';
        until pg_isready -h 127.0.0.1 -p 5432 -U $POSTGRES_USER; do
          echo '‚è≥   Still waiting for PostgreSQL...';
          sleep 2;
        done;

        echo '‚úÖ   PostgreSQL is ready! Proceeding with initialization...';

        # Ensure the main database exists
        echo \"Checking if main database '$POSTGRES_DB_PROD' exists...\";
        if psql -U \"$POSTGRES_USER\" -d postgres -tAc \"SELECT 1 FROM pg_database WHERE datname='$POSTGRES_DB_PROD'\" | grep -q 1; then
          echo '‚úÖ   Main database \"$POSTGRES_DB_PROD\" already exists.';
        else
          echo 'üöÄ   Creating main database: \"$POSTGRES_DB_PROD\"';
          psql -U \"$POSTGRES_USER\" -d postgres -c \"CREATE DATABASE \\\"$POSTGRES_DB_PROD\\\";\";
        fi;

        # Check if test database exists and create schema 'public'
        echo \"Checking if test database '$POSTGRES_DB_TEST' exists...\";
        if psql -U \"$POSTGRES_USER\" -d postgres -tAc \"SELECT 1 FROM pg_database WHERE datname='$POSTGRES_DB_TEST'\" | grep -q 1; then
          echo '‚úÖ   Test database \"$POSTGRES_DB_TEST\" already exists.';
        else
          echo 'üöÄ   Creating test database: \"$POSTGRES_DB_TEST\"';
          psql -U \"$POSTGRES_USER\" -d postgres -c \"CREATE DATABASE \\\"$POSTGRES_DB_TEST\\\";\";
        fi;

        echo \"Checking if dev database '$POSTGRES_DB_DEV' exists...\";
        if psql -U \"$POSTGRES_USER\" -d postgres -tAc \"SELECT 1 FROM pg_database WHERE datname='$POSTGRES_DB_DEV'\" | grep -q 1; then
          echo '‚úÖ   Dev database \"$POSTGRES_DB_DEV\" already exists.';
        else
          echo 'üöÄ   Creating dev database: \"$POSTGRES_DB_DEV\"';
          psql -U \"$POSTGRES_USER\" -d postgres -c \"CREATE DATABASE \\\"$POSTGRES_DB_DEV\\\";\";
        fi;

        echo 'üîß   Ensuring schema public exists on main database...'
        psql -U \"$POSTGRES_USER\" -d \"$POSTGRES_DB_PROD\" -c 'CREATE SCHEMA IF NOT EXISTS public;';
        
        echo 'üîß   Ensuring schema public exists on test database...';
        psql -U \"$POSTGRES_USER\" -d \"$POSTGRES_DB_TEST\" -c 'CREATE SCHEMA IF NOT EXISTS public;';

        echo 'üîß   Ensuring schema public exists on dev database...'
        psql -U \"$POSTGRES_USER\" -d \"$POSTGRES_DB_DEV\" -c 'CREATE SCHEMA IF NOT EXISTS public;';

        echo 'üéâ   Database initialization complete!';

        # Keep PostgreSQL running in the foreground to prevent container exit
        wait
      "
    networks:
      - mynute-app-network

  pgadmin:
    image: dpage/pgadmin4:latest
    restart: always
    env_file:
      - .env
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - mynute-app-network
      - dokploy-network
    labels:
      # Enable Traefik
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
      # External URL
      - "traefik.http.routers.mynute-pgadmin-prod-http.rule=Host(`${PGADMIN_EXTERNAL_DOMAIN}`)"
      - "traefik.http.routers.mynute-pgadmin-prod-http.entrypoints=websecure"
      - "traefik.http.routers.mynute-pgadmin-prod-http.tls.certresolver=letsencrypt"
      - "traefik.http.services.mynute-pgadmin-prod-http.loadbalancer.server.port=80"
    volumes:
      - pgadmin-data:/var/lib/pgadmin

  # Auto-run migrations on deploy if RUN_PROD_MIGRATIONS=true
  migrate-auto:
    build: .
    env_file:
      - .env
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - RUN_PROD_MIGRATIONS=${RUN_PROD_MIGRATIONS:-false}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - mynute-app-network
    command: >
      sh -c '
        if [ "$$RUN_PROD_MIGRATIONS" = "true" ]; then
          echo "üöÄ Running migrations...";
          ./migrate-tool -action=up "-path=/mynute-go/migrations";
        else
          echo "‚è≠Ô∏è  Skipping migrations (RUN_PROD_MIGRATIONS not set to true)";
        fi
      '
    restart: "no"

  # Auto-run seeding on deploy if RUN_PROD_SEED=true
  seed-auto:
    build: .
    env_file:
      - .env
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - RUN_PROD_SEED=${RUN_PROD_SEED:-false}
    depends_on:
      postgres:
        condition: service_healthy
      migrate-auto:
        condition: service_completed_successfully
    networks:
      - mynute-app-network
    command: >
      sh -c '
        if [ "$$RUN_PROD_SEED" = "true" ]; then
          echo "üå± Running seed...";
          ./seed-tool;
        else
          echo "‚è≠Ô∏è  Skipping seed (RUN_PROD_SEED not set to true)";
        fi
      '
    restart: "no"

  go-backend-app:
    build: .
    restart: always
    env_file:
      - .env
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - APP_ENV=${APP_ENV:-prod}
    depends_on:
      postgres:
        condition: service_healthy
      migrate-auto:
        condition: service_completed_successfully
      seed-auto:
        condition: service_completed_successfully
      grafana:
        condition: service_healthy
      loki:
        condition: service_started
    networks:
      - mynute-app-network
      - dokploy-network
    labels:
      # Enable Traefik
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
      # External URL
      - "traefik.http.routers.mynute-backend-prod-http.rule=Host(`${BACKEND_EXTERNAL_DOMAIN}`)"
      - "traefik.http.routers.mynute-backend-prod-http.entrypoints=websecure"
      - "traefik.http.routers.mynute-backend-prod-http.tls.certresolver=letsencrypt"
      - "traefik.http.services.mynute-backend-prod-http.loadbalancer.server.port=${APP_PORT}"

  prometheus:
    image: prom/prometheus:v3.4.1
    restart: always
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    depends_on:
      - postgres
    networks:
      - mynute-app-network

  grafana:
    image: grafana/grafana:12.0.1
    restart: always
    volumes:
      - grafana-data:/var/lib/grafana
    ports:
      - "${GRAFANA_ALIAS_PORT}:${GRAFANA_PORT}"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/login"]
      interval: 300s
      timeout: 5s
      retries: 10
      start_period: 15s
    depends_on:
      - prometheus
      - loki
    networks:
      - mynute-app-network
    environment:
      - GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD}

  loki:
    user: root
    restart: always
    image: grafana/loki:3.5.1
    command: -config.file=/etc/loki/loki-config.yaml
    volumes:
      - ./loki-config.yaml:/etc/loki/loki-config.yaml
      - loki-index:/loki/index
      - loki-cache:/loki/cache
      - loki-chunks:/loki/chunks
      - loki-compactor:/loki/compactor
      - loki-wal:/loki/wal
    networks:
      - mynute-app-network
      
networks:
  mynute-app-network:
    driver: bridge
  dokploy-network:
    external: true

volumes:
  postgres-data:
  pgadmin-data:
  grafana-data:
  loki-index:
  loki-cache:
  loki-chunks:
  loki-compactor:
  loki-wal:
  minio-data:
